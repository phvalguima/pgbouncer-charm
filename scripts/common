#!/bin/bash

# Copyright 2012 Canonical Ltd. All rights reserved.
# Author: Haw Loeung <haw.loeung@canonical.com>

# pgbouncer charm common functions used by various hooks

set -eux # -x for verbose logging to juju debug-log

SERVICE_AFFECTING_PACKAGES="pgbouncer"

update_config()
{
	pgbouncer_userlist=/etc/pgbouncer/userlist.txt
	local pgbouncer_userlist_new=$(/bin/mktemp --suffix=.juju)
	for file in $(find /var/lib/juju/ -maxdepth 1 -name '*\.password' -type f); do
		pgbouncer_user=$(basename $file | awk -F. '{print $1}')
		echo "\"$pgbouncer_user\" \"$(cat $file)\"" >> $pgbouncer_userlist_new
	done
	chown postgres:postgres $pgbouncer_userlist_new
	chmod 600 $pgbouncer_userlist_new
	mv $pgbouncer_userlist_new $pgbouncer_userlist

	local pgbouncer_config="/etc/pgbouncer/pgbouncer.ini"
	local general_template="templates/pgbouncer.ini.general.tmpl"

	# Copy existing config file to preserve permissions.
	local pgbouncer_config_new=$(/bin/mktemp --suffix=.juju)
	cp -a $pgbouncer_config $pgbouncer_config_new

	# Generate the "databases" section first from list of Juju relations.
	echo "[databases]" > $pgbouncer_config_new 
	(find /var/lib/juju/ -maxdepth 1 -name 'db-*' -type f -print0 | xargs --null cat) \
		>> $pgbouncer_config_new

	# Generate the general "pgbouncer" section with configuration options
	# from Juju's configs.
	local admin_users=$(config-get admin_users)
	local auth_file=$(config-get auth_file)
	local auth_type=$(config-get auth_type)
	local client_login_timeout=$(config-get client_login_timeout)
	local default_pool_size=$(config-get default_pool_size)
	local ignore_startup_parameters=$(config-get ignore_startup_parameters)
	local listen_addr=$(config-get listen_addr)
	local listen_port=$(config-get listen_port)
	local logfile=$(config-get logfile)
	local max_client_conn=$(config-get max_client_conn)
	local pidfile=$(config-get pidfile)
	local pool_mode=$(config-get pool_mode)
	local reserve_pool_size=$(config-get reserve_pool_size)
	local server_check_delay=$(config-get server_check_delay)
	local server_connect_timeout=$(config-get server_connect_timeout)
	local server_idle_timeout=$(config-get server_idle_timeout)
	local server_lifetime=$(config-get server_lifetime)
	local server_login_retry=$(config-get server_login_retry)
	cheetah fill --env --stdout $general_template >> $pgbouncer_config_new

	# Looks good, let's make it live.
	mv $pgbouncer_config_new $pgbouncer_config

	# Clean up
	rm -f $pgbouncer_userlist_new $pgbouncer_config_new

	juju-log "reloading pgbouncer"
	service pgbouncer reload || exit 1
}

ensure_package_status()
{
	packages="$1" ; shift
	status="$1" ; shift

	case $status in
	install|hold)
		for package in ${packages}; do
			echo ${package} ${status}
		done | dpkg --set-selections
		;;
	*)
		;;
	esac
}
